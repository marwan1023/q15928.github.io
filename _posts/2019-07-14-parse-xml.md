---
layout:     post
title:      "Parsing XML files made simple by PySpark"
date:       2019-07-14 12:00:00
author:     "Jason Feng"
header-img: "img/post-bg-2015.jpg"
excerpt_separator: <!--more-->
tags:
    - PySpark
    - XML
    - Data Processing
---

Imagine you are given a task to parse thousands of xml files to extract the information, write the records into table format with proper data types, the task must be done in a timely manner and is repeated every hour. What are you going to do? With Apache Spark, the embarrassingly parallel processing framework, it can be done with much less effort.

<!--more-->

### Introduction
In this blog, we are going to use PySpark to process xml files to extract the required records, transform them into DataFrame, then write as csv files (or any other format) to the destination. The input and the output of this task looks like below.
![](/img/xml-2-dataframe-2019-07-20.png)

#### XML
[XML](https://www.w3schools.com/xml/xml_whatis.asp) is designed to store and transport data. XML is self-descriptive which makes it flexibile and extensible to store different kinds of data. On the other hand, it makes difficult to convert into tabular data because of its nature of semi-structured.

```python
# read each xml file as one row, then convert to RDD
file_rdd = spark.read.text("./data/*.xml", wholetext=True).rdd
```

```python

[Row(value='<?xml version="1.0"?>\r\n<catalog>\r\n   <book id="bk119">\r\n      <author>Feng, Jason</author>\r\n      <title>Playground</title>\r\n      <description>This is the place where Jason puts his fun stuff\r\n      mainly related with Python, R and GCP.</description>\r\n   </book>\r\n</catalog>')]
```

```python
# parse xml tree, extract the records and transform to new RDD
records_rdd = file_rdd.flatMap(parse_xml)
```

```python
def parse_xml(rdd):
    """
    Read the xml string from rdd, parse and extract the elements,
    then return a list of list.
    """
    results = []
    root = ET.fromstring(rdd[0])

    for b in root.findall('book'):
        rec = []
        rec.append(b.attrib['id'])
        for e in ELEMENTS_TO_EXTRAT:
            value = None
            if b.find(e) is None:
                rec.append(value)
                continue
            value = b.find(e).text
            if e == 'price':
                value = float(value)
            elif e == 'publish_date':
                value = datetime.strptime(value, '%Y-%m-%d')
            rec.append(value)
        results.append(rec)

    return results
```

#### To be finished...
Source codes are [here](https://github.com/q15928/python-snippets/blob/master/pyspark/parse-xml/xml-parse.py).